// Prisma Schema for CiviLabs LMS
// Database: Neon PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== AUTH MODELS ====================

enum UserRole {
  STUDENT
  INSTRUCTOR
  ADMIN
}

model User {
  id                String    @id @default(cuid())
  name              String?
  email             String    @unique
  emailVerified     DateTime?
  image             String?
  password          String?
  role              UserRole  @default(STUDENT)
  bio               String?
  profileVisibility Boolean   @default(true) // true = public, false = private (student privacy)
  mfaEnabled        Boolean   @default(false)
  consentAcceptedAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  accounts               Account[]
  sessions               Session[]
  courses                Course[]         @relation("InstructorCourses")
  enrollments            Enrollment[]
  certificates           Certificate[]
  discussions            Discussion[]
  replies                Reply[]
  messages               Message[]
  progress               UserProgress[]
  quizAttempts           QuizAttempt[]
  forumThreads           ForumThread[]
  forumReplies           ForumReply[]
  media                  Media[]
  notifications          Notification[]
  notificationPreference NotificationPreference?
  learningPathEnrollments LearningPathEnrollment[]
  bookmarks              Bookmark[]
  notes                  Note[]
  courseReviews          CourseReview[]
  assignmentSubmissions  AssignmentSubmission[]
  studentGrades          StudentGrade[]
  announcements          Announcement[]
  attendanceRecords      AttendanceRecord[]
  activities             UserActivity[]
  mfaConfig             MFAConfig?
  consents              ConsentRecord[]
  calendarEvents        CalendarEvent[]
  groupMemberships      GroupMember[]
  calendarTokens        CalendarToken[]
  webhooks              Webhook[]
  apiKeys               APIKey[]

  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==================== COURSE MODELS ====================

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courses Course[]

  @@map("categories")
}

model Course {
  id           String    @id @default(cuid())
  title        String
  slug         String    @unique
  description  String?   @db.Text
  imageUrl     String?
  isPublished  Boolean   @default(false)
  instructorId String
  categoryId   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  instructor         User          @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Cascade)
  category           Category?     @relation(fields: [categoryId], references: [id])
  chapters           Chapter[]
  enrollments        Enrollment[]
  certificates       Certificate[]
  discussions        Discussion[]
  chatRoom           ChatRoom?
  media              Media[]
  learningPaths      LearningPathCourse[]
  prerequisites      CoursePrerequisite[] @relation("CoursePrerequisites")
  prerequisiteFor    CoursePrerequisite[] @relation("PrerequisiteFor")
  reviews            CourseReview[]
  assignments        Assignment[]
  questionBanks      QuestionBank[]
  rubrics            Rubric[]
  gradeCategories    GradeCategory[]
  gradingScales      GradingScale[]
  releaseConditions  ReleaseCondition[]
  announcements      Announcement[]
  attendanceSessions AttendanceSession[]
  approval           CourseApproval?
  calendarEvents     CalendarEvent[]
  groups             CourseGroup[]

  @@index([instructorId])
  @@index([categoryId])
  @@index([isPublished])
  @@index([createdAt])
  @@index([isPublished, createdAt])
  @@map("courses")
}

model Chapter {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  position    Int
  isPublished Boolean  @default(false)
  isFree      Boolean  @default(false)
  courseId    String
  availableFrom  DateTime? // Content scheduling
  availableUntil DateTime? // Content scheduling
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
  quiz        Quiz?
  assignments Assignment[]

  @@index([courseId])
  @@map("chapters")
}

enum LessonType {
  VIDEO
  PDF
  DOCUMENT
  POWERPOINT
  SCENE_3D
  TEXT
}

model Lesson {
  id            String     @id @default(cuid())
  title         String
  description   String?    @db.Text
  type          LessonType
  content       String?    @db.Text // For TEXT type lessons
  videoUrl      String?
  attachmentUrl String?
  sceneConfig   Json?      // For 3D scene configuration
  position      Int
  duration      Int?       // Duration in seconds (for video)
  chapterId     String
  availableFrom  DateTime? // Content scheduling
  availableUntil DateTime? // Content scheduling
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  chapter   Chapter        @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  progress  UserProgress[]
  bookmarks Bookmark[]
  notes     Note[]

  @@index([chapterId])
  @@map("lessons")
}

// ==================== ASSESSMENT MODELS (formerly Quiz) ====================

enum QuestionType {
  MULTIPLE_CHOICE    // Original type: pick one from options
  TRUE_FALSE         // Boolean answer
  SHORT_ANSWER       // Text input with accepted answers
  MULTI_SELECT       // Multiple correct answers
  MATCHING           // Two-column matching pairs
  ORDERING           // Drag-to-order items
  ESSAY              // Free-form text, manual grading required
  FILL_IN_BLANK      // Inline blanks with accepted variants
}

enum AssessmentType {
  QUIZ               // Low-stakes, multiple attempts typically allowed
  EXAM               // High-stakes, limited attempts, may be timed
  PRACTICE           // Unlimited attempts, no grade impact
}

model Quiz {
  id              String         @id @default(cuid())
  title           String
  description     String?        @db.Text
  passingScore    Int            @default(70) // Percentage
  chapterId       String         @unique
  assessmentType  AssessmentType @default(QUIZ)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Assessment Configuration (nullable for backward compat with existing quizzes)
  timeLimit           Int?       // Time limit in minutes (null = untimed)
  attemptLimit        Int?       // Max attempts (null = unlimited)
  availableFrom       DateTime?  // Start availability window
  availableUntil      DateTime?  // End availability window
  shuffleQuestions    Boolean    @default(false)
  shuffleOptions      Boolean    @default(false)
  showAnswersAfter    String?    @default("SUBMISSION") // SUBMISSION, AFTER_DUE, MANUAL, NEVER
  isProctored         Boolean    @default(false)
  passwordProtected   String?    // Entry password (null = no password)
  ipRestrictions      Json?      // Array of allowed IP ranges
  honorCodeRequired   Boolean    @default(false)
  lateGracePeriod     Int?       // Minutes allowed after time expires (marked late)
  lateSubmissionPolicy String?   @default("ACCEPT") // ACCEPT, REJECT, PENALTY
  latePenaltyPercent  Int?       @default(0)        // % deducted if late
  poolSize            Int?       // Number of questions to pull from bank (null = all)
  questionBankId      String?    // Optional: pull questions from bank

  // Relations
  chapter      Chapter          @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  questions    Question[]
  attempts     QuizAttempt[]
  questionBank QuestionBank?    @relation(fields: [questionBankId], references: [id], onDelete: SetNull)

  @@index([assessmentType])
  @@index([availableFrom])
  @@index([availableUntil])
  @@map("quizzes")
}

model Question {
  id            String       @id @default(cuid())
  text          String       @db.Text
  type          QuestionType @default(MULTIPLE_CHOICE)
  options       Json?        // Array of options (for MULTIPLE_CHOICE, MULTI_SELECT)
  correctAnswer Int?         // Index of correct option (MULTIPLE_CHOICE only)
  points        Int          @default(1)
  position      Int
  quizId        String?      // Nullable: can belong to quiz or question bank
  explanation   String?      @db.Text  // Shown after answer submission

  // Extended fields for new question types
  acceptedAnswers  Json?     // SHORT_ANSWER/FILL_IN_BLANK: array of accepted answers [{text, matchMode: "exact"|"contains"|"regex"}]
  matchingPairs    Json?     // MATCHING: array of {left, right} pairs
  orderingItems    Json?     // ORDERING: array of items in correct order
  correctBoolAnswer Boolean? // TRUE_FALSE: the correct answer
  blanks           Json?     // FILL_IN_BLANK: array of {position, acceptedAnswers[]}
  multiSelectAnswers Json?   // MULTI_SELECT: array of correct option indices
  partialCreditEnabled Boolean @default(false) // MULTI_SELECT: allow partial credit
  essayWordLimit   Int?      // ESSAY: max word count
  essayRubricId    String?   // ESSAY: optional rubric for grading guidance

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  quiz          Quiz?        @relation(fields: [quizId], references: [id], onDelete: Cascade)
  bankItems     QuestionBankItem[]

  @@index([quizId])
  @@index([type])
  @@map("questions")
}

model QuizAttempt {
  id              String    @id @default(cuid())
  userId          String
  quizId          String
  score           Int       // Percentage score
  passed          Boolean
  answers         Json      // User's answers: { [questionId]: answer }
  completedAt     DateTime  @default(now())

  // Extended fields for assessment features
  startedAt       DateTime? // When the attempt was started (for timed assessments)
  timeSpentSeconds Int?     // Total time spent in seconds
  isLate          Boolean   @default(false)
  honorCodeAccepted Boolean @default(false)
  ipAddress       String?   // For IP restriction auditing
  questionsServed Json?     // Which questions were served (for randomized pools)
  earnedPoints    Int?      // Raw points earned
  totalPoints     Int?      // Total possible points
  needsManualGrading Boolean @default(false) // Has essay/short-answer needing review
  manualGradedAt  DateTime?
  manualGradedBy  String?   // Instructor who graded

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([needsManualGrading])
  @@index([userId, quizId])
  @@map("quiz_attempts")
}

// ==================== QUESTION BANK ====================

model QuestionBank {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  courseId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course  Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  items   QuestionBankItem[]
  quizzes Quiz[]             // Quizzes that pull from this bank

  @@index([courseId])
  @@map("question_banks")
}

model QuestionBankItem {
  id             String   @id @default(cuid())
  questionBankId String
  questionId     String
  position       Int      @default(0)
  createdAt      DateTime @default(now())

  // Relations
  questionBank QuestionBank @relation(fields: [questionBankId], references: [id], onDelete: Cascade)
  question     Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([questionBankId, questionId])
  @@index([questionBankId])
  @@index([questionId])
  @@map("question_bank_items")
}

// ==================== ASSIGNMENT SYSTEM ====================

enum AssignmentType {
  FILE_UPLOAD
  TEXT_ENTRY
  URL_LINK
  MEDIA_RECORDING
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  GRADED
  RETURNED
  LATE
}

enum LatePolicy {
  ACCEPT_LATE
  REJECT_LATE
  NO_DUE_DATE
}

model Assignment {
  id                String         @id @default(cuid())
  title             String
  description       String?        @db.Text
  type              AssignmentType @default(FILE_UPLOAD)
  courseId           String
  chapterId         String?        // Optional: associate with a chapter
  dueDate           DateTime?
  points            Int            @default(100)
  isPublished       Boolean        @default(false)
  position          Int            @default(0)

  // Submission config
  allowedFileTypes  String?        // Comma-separated: ".pdf,.docx,.zip"
  maxFileSize       Int?           // Max file size in MB
  maxSubmissions    Int            @default(1) // Max resubmissions allowed
  latePolicy        LatePolicy     @default(ACCEPT_LATE)
  latePenaltyPercent Int           @default(0) // % penalty per day late

  // Availability
  availableFrom     DateTime?
  availableUntil    DateTime?

  // Grading
  rubricId          String?
  isGroupAssignment Boolean        @default(false)

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  course      Course                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapter     Chapter?              @relation(fields: [chapterId], references: [id], onDelete: SetNull)
  rubric      Rubric?               @relation(fields: [rubricId], references: [id], onDelete: SetNull)
  submissions AssignmentSubmission[]

  @@index([courseId])
  @@index([chapterId])
  @@index([dueDate])
  @@index([isPublished])
  @@map("assignments")
}

model AssignmentSubmission {
  id              String           @id @default(cuid())
  assignmentId    String
  userId          String
  status          SubmissionStatus @default(DRAFT)
  submissionNumber Int             @default(1) // Which attempt this is
  groupId         String?          // If group assignment, which group submitted

  // Submission content (varies by assignment type)
  fileUrl         String?
  fileName        String?
  fileSize        Int?             // Bytes
  textContent     String?          @db.Text
  urlLink         String?

  // Grading
  grade           Float?           // Points earned
  feedback        String?          @db.Text
  rubricScores    Json?            // { [criterionId]: { levelIndex, points, comment } }
  gradedAt        DateTime?
  gradedBy        String?          // Instructor user ID

  // Timestamps
  submittedAt     DateTime?
  isLate          Boolean          @default(false)
  latePenaltyApplied Float?        // Actual penalty applied (points deducted)

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  assignment Assignment  @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  group      CourseGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@index([assignmentId])
  @@index([userId])
  @@index([status])
  @@index([assignmentId, userId])
  @@index([groupId])
  @@map("assignment_submissions")
}

// ==================== RUBRIC SYSTEM ====================

model Rubric {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  courseId     String
  isTemplate  Boolean  @default(false) // Can be reused across courses
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  criteria    RubricCriterion[]
  assignments Assignment[]

  @@index([courseId])
  @@index([createdBy])
  @@map("rubrics")
}

model RubricCriterion {
  id          String @id @default(cuid())
  rubricId    String
  title       String
  description String?  @db.Text
  position    Int
  maxPoints   Int      @default(10)
  levels      Json     // Array of { label: string, description: string, points: number }

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rubric Rubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  @@index([rubricId])
  @@map("rubric_criteria")
}

// ==================== PROGRESS & ENROLLMENT ====================

model Enrollment {
  id          String    @id @default(cuid())
  userId      String
  courseId    String
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("enrollments")
}

model UserProgress {
  id          String   @id @default(cuid())
  userId      String
  lessonId    String
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("user_progress")
}

// ==================== CERTIFICATES ====================

model Certificate {
  id         String   @id @default(cuid())
  uniqueCode String   @unique @default(cuid())
  userId     String
  courseId   String
  issuedAt   DateTime @default(now())
  pdfUrl     String?

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("certificates")
}

// ==================== FORUMS ====================

model ForumCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  icon        String?  // Lucide icon name
  color       String?  // Tailwind color class
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  threads ForumThread[]

  @@map("forum_categories")
}

model ForumThread {
  id         String   @id @default(cuid())
  title      String
  content    String   @db.Text
  userId     String
  categoryId String
  isPinned   Boolean  @default(false)
  isLocked   Boolean  @default(false)
  views      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  category ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  replies  ForumReply[]

  @@index([categoryId])
  @@index([userId])
  @@map("forum_threads")
}

model ForumReply {
  id        String   @id @default(cuid())
  content   String   @db.Text
  userId    String
  threadId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  thread ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([userId])
  @@map("forum_replies")
}

// ==================== CHAT & DISCUSSIONS ====================

model ChatRoom {
  id        String   @id @default(cuid())
  courseId  String   @unique
  createdAt DateTime @default(now())

  // Relations
  course   Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  messages Message[]

  @@map("chat_rooms")
}

model Message {
  id        String   @id @default(cuid())
  content   String   @db.Text
  userId    String
  roomId    String
  createdAt DateTime @default(now())

  // Relations
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  room ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([userId])
  @@map("messages")
}

model Discussion {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  userId    String
  courseId  String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  replies Reply[]

  @@index([courseId])
  @@index([userId])
  @@map("discussions")
}

model Reply {
  id           String   @id @default(cuid())
  content      String   @db.Text
  userId       String
  discussionId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  discussion Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)

  @@index([discussionId])
  @@index([userId])
  @@map("replies")
}

// ==================== MEDIA LIBRARY ====================

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
  MODEL_3D
  OTHER
}

model Media {
  id          String    @id @default(cuid())
  name        String
  url         String
  type        MediaType
  size        Int       // Size in bytes
  mimeType    String?
  userId      String
  courseId    String?   // Optional: associate with a course
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([courseId])
  @@index([type])
  @@map("media")
}

// ==================== NOTIFICATIONS ====================

enum NotificationType {
  ENROLLMENT          // New enrollment in your course
  COURSE_PUBLISHED    // Course you're enrolled in is published
  CERTIFICATE_EARNED  // Certificate earned
  QUIZ_PASSED         // Quiz passed
  QUIZ_FAILED         // Quiz failed
  FORUM_REPLY         // Reply to your forum thread
  CHAT_MESSAGE        // New chat message (when mentioned)
  COURSE_UPDATE       // Course content updated
  ANNOUNCEMENT        // System announcement
  WELCOME             // Welcome notification
  ASSIGNMENT_DUE      // Assignment due date approaching
  ASSIGNMENT_GRADED   // Assignment has been graded
  ASSIGNMENT_RETURNED // Assignment returned for revision
  ASSESSMENT_AVAILABLE // New assessment available
  MANUAL_GRADE_NEEDED // Essay/short-answer needs grading (instructor)
  COURSE_APPROVED     // Course approved by admin
  COURSE_REJECTED     // Course rejected by admin
  COURSE_REVIEW_REQUESTED // Course submitted for admin review
  MFA_ENABLED_NOTICE  // MFA has been enabled on account
  CALENDAR_REMINDER   // Calendar event reminder (24h/1h before)
  GROUP_INVITATION    // Invited to join a course group
  GROUP_SUBMISSION    // Group member submitted on your behalf
}

model Notification {
  id          String           @id @default(cuid())
  type        NotificationType
  title       String
  message     String           @db.Text
  read        Boolean          @default(false)
  userId      String
  link        String?          // Optional link to navigate to
  metadata    Json?            // Additional data (courseId, threadId, etc.)
  createdAt   DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

// ==================== ADVANCED LEARNING FEATURES ====================

// Learning Paths - Curated sequences of courses
model LearningPath {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String?  @db.Text
  imageUrl    String?
  isPublished Boolean  @default(false)
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  courses      LearningPathCourse[]
  enrollments  LearningPathEnrollment[]

  @@map("learning_paths")
}

model LearningPathCourse {
  id             String @id @default(cuid())
  learningPathId String
  courseId       String
  position       Int

  // Relations
  learningPath LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  course       Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([learningPathId, courseId])
  @@index([learningPathId])
  @@index([courseId])
  @@map("learning_path_courses")
}

model LearningPathEnrollment {
  id             String    @id @default(cuid())
  userId         String
  learningPathId String
  startedAt      DateTime  @default(now())
  completedAt    DateTime?

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  learningPath LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)

  @@unique([userId, learningPathId])
  @@index([userId])
  @@index([learningPathId])
  @@map("learning_path_enrollments")
}

// Course Prerequisites
model CoursePrerequisite {
  id                   String @id @default(cuid())
  courseId             String
  prerequisiteCourseId String

  // Relations
  course             Course @relation("CoursePrerequisites", fields: [courseId], references: [id], onDelete: Cascade)
  prerequisiteCourse Course @relation("PrerequisiteFor", fields: [prerequisiteCourseId], references: [id], onDelete: Cascade)

  @@unique([courseId, prerequisiteCourseId])
  @@index([courseId])
  @@index([prerequisiteCourseId])
  @@map("course_prerequisites")
}

// Bookmarks - Save lessons for later
model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  note      String?  @db.Text
  createdAt DateTime @default(now())

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("bookmarks")
}

// Notes - Personal annotations per lesson
model Note {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  content   String   @db.Text
  timestamp Int?     // Optional: timestamp in video (seconds)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
  @@index([userId, lessonId])
  @@map("notes")
}

// Course Reviews and Ratings
model CourseReview {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  rating    Int      // 1-5 stars
  title     String?
  content   String?  @db.Text
  isPublic  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([rating])
  @@map("course_reviews")
}

// ==================== AUDIT LOGS ====================

enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGE
  PASSWORD_RESET_REQUEST

  // User Management
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  ROLE_CHANGED

  // Course Management
  COURSE_CREATED
  COURSE_UPDATED
  COURSE_DELETED
  COURSE_PUBLISHED
  COURSE_UNPUBLISHED

  // Enrollment
  ENROLLMENT_CREATED
  ENROLLMENT_DELETED
  COURSE_COMPLETED

  // Content
  CHAPTER_CREATED
  CHAPTER_UPDATED
  CHAPTER_DELETED
  LESSON_CREATED
  LESSON_UPDATED
  LESSON_DELETED

  // Quiz / Assessment
  QUIZ_ATTEMPTED
  QUIZ_PASSED
  QUIZ_FAILED
  ASSESSMENT_CREATED
  ASSESSMENT_UPDATED
  ASSESSMENT_DELETED

  // Assignment
  ASSIGNMENT_CREATED
  ASSIGNMENT_UPDATED
  ASSIGNMENT_DELETED
  ASSIGNMENT_SUBMITTED
  ASSIGNMENT_GRADED
  ASSIGNMENT_RETURNED

  // Gradebook
  GRADE_OVERRIDDEN
  GRADE_EXPORTED

  // Announcements
  ANNOUNCEMENT_CREATED
  ANNOUNCEMENT_UPDATED
  ANNOUNCEMENT_DELETED

  // Attendance
  ATTENDANCE_RECORDED
  ATTENDANCE_UPDATED

  // Course Cloning
  COURSE_CLONED

  // MFA (Phase 16)
  MFA_ENABLED
  MFA_DISABLED
  MFA_VERIFIED
  MFA_FAILED

  // Course Approval (Phase 16)
  COURSE_SUBMITTED_FOR_REVIEW
  COURSE_APPROVED
  COURSE_REJECTED
  COURSE_CHANGES_REQUESTED

  // Email Campaigns (Phase 16)
  CAMPAIGN_CREATED
  CAMPAIGN_SENT

  // Data Retention (Phase 16)
  RETENTION_POLICY_CREATED
  RETENTION_POLICY_EXECUTED
  USER_DATA_EXPORTED
  USER_DATA_DELETED
  CONSENT_GRANTED
  CONSENT_REVOKED

  // Calendar (Phase 17)
  CALENDAR_EVENT_CREATED
  CALENDAR_EVENT_UPDATED
  CALENDAR_EVENT_DELETED

  // Groups (Phase 17)
  GROUP_CREATED
  GROUP_UPDATED
  GROUP_DELETED
  GROUP_MEMBER_ADDED
  GROUP_MEMBER_REMOVED

  // Webhooks & API Keys (Phase 19)
  WEBHOOK_CREATED
  WEBHOOK_UPDATED
  WEBHOOK_DELETED
  API_KEY_CREATED
  API_KEY_REVOKED

  // Admin Actions
  SETTINGS_CHANGED
  DATA_EXPORTED
  BULK_ACTION
}

model AuditLog {
  id          String      @id @default(cuid())
  action      AuditAction
  userId      String?     // Who performed the action (null for system actions)
  targetId    String?     // ID of the affected resource
  targetType  String?     // Type of resource (User, Course, etc.)
  ipAddress   String?
  userAgent   String?
  details     Json?       // Additional context
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([action])
  @@index([targetId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== USER SETTINGS ====================

model NotificationPreference {
  id        String  @id @default(cuid())
  userId    String  @unique

  // Notification category toggles
  emailEnrollment      Boolean @default(true)  // New enrollment notifications
  emailCourseUpdates   Boolean @default(true)  // Course content updates
  emailCertificates    Boolean @default(true)  // Certificate earned
  emailQuizResults     Boolean @default(true)  // Quiz pass/fail
  emailForumReplies    Boolean @default(true)  // Forum reply notifications
  emailAnnouncements   Boolean @default(true)  // System announcements
  emailChatMentions    Boolean @default(false) // Chat mentions (off by default)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model PlatformSettings {
  id                    String   @id @default(cuid())
  registrationOpen      Boolean  @default(true)   // Allow new user registration
  defaultRole           UserRole @default(STUDENT) // Default role for new users
  maintenanceMode       Boolean  @default(false)  // Platform maintenance mode
  platformName          String   @default("CiviLabs")
  platformDescription   String?  @db.Text
  maxFileUploadSize     Int      @default(10)     // MB
  allowedFileTypes      String   @default("image/*,application/pdf,video/*")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("platform_settings")
}

// ==================== GRADEBOOK SYSTEM (Phase 15) ====================

model GradeCategory {
  id          String   @id @default(cuid())
  name        String
  weight      Float    @default(0) // Percentage weight (all categories should sum to 100)
  courseId     String
  position    Int      @default(0)
  dropLowest  Int      @default(0) // Number of lowest grades to drop

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  gradeItems  GradeItem[]

  @@index([courseId])
  @@map("grade_categories")
}

model GradeItem {
  id            String   @id @default(cuid())
  categoryId    String
  title         String
  points        Float    @default(100)
  type          GradeItemType @default(MANUAL)
  referenceId   String?  // Links to assignmentId or quizId
  isExtraCredit Boolean  @default(false)
  isVisible     Boolean  @default(true) // Hidden from students until released
  dueDate       DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  category      GradeCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  studentGrades StudentGrade[]

  @@index([categoryId])
  @@index([referenceId])
  @@map("grade_items")
}

enum GradeItemType {
  ASSIGNMENT
  ASSESSMENT
  ATTENDANCE
  MANUAL
}

model StudentGrade {
  id            String   @id @default(cuid())
  gradeItemId   String
  userId        String
  score         Float?   // Points earned (null = not yet graded)
  letterGrade   String?  // Computed letter grade
  overrideScore Float?   // Manual override by instructor
  overrideBy    String?  // Instructor who overrode
  overrideReason String?
  gradedAt      DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  gradeItem     GradeItem @relation(fields: [gradeItemId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gradeItemId, userId])
  @@index([gradeItemId])
  @@index([userId])
  @@map("student_grades")
}

model GradingScale {
  id          String   @id @default(cuid())
  name        String
  courseId     String?  // null = global/default scale
  isDefault   Boolean  @default(false)
  levels      Json     // Array of {label, minPercent, maxPercent, gpaValue}

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@map("grading_scales")
}

// ==================== RELEASE CONDITIONS (Phase 15) ====================

model ReleaseCondition {
  id              String   @id @default(cuid())
  targetType      String   // CHAPTER, LESSON, ASSIGNMENT, ASSESSMENT
  targetId        String   // ID of the content item
  courseId         String
  conditionType   String   // DATE_AFTER, LESSON_COMPLETED, CHAPTER_COMPLETED, ASSESSMENT_PASSED, ASSESSMENT_SCORE_ABOVE, ASSIGNMENT_SUBMITTED, ASSIGNMENT_GRADED
  conditionValue  Json     // { date, lessonId, chapterId, assessmentId, minScore, assignmentId }
  operator        String   @default("AND") // AND or OR with other conditions on same target
  position        Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([targetType, targetId])
  @@index([courseId])
  @@map("release_conditions")
}

// ==================== ANNOUNCEMENTS (Phase 15) ====================

model Announcement {
  id            String    @id @default(cuid())
  title         String
  content       String    @db.Text
  courseId       String?   // null = global/platform announcement
  authorId      String
  isPinned      Boolean   @default(false)
  isPublished   Boolean   @default(true)
  publishedAt   DateTime  @default(now())
  scheduledFor  DateTime? // Future publish date
  attachmentUrl String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  course        Course?   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  author        User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([authorId])
  @@index([publishedAt])
  @@index([isPublished, publishedAt])
  @@map("announcements")
}

// ==================== ATTENDANCE (Phase 15) ====================

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

model AttendanceSession {
  id          String   @id @default(cuid())
  courseId     String
  date        DateTime @default(now())
  title       String?  // Optional session label
  type        String   @default("IN_PERSON") // IN_PERSON, VIRTUAL, ASYNC
  notes       String?  @db.Text
  createdBy   String

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  records     AttendanceRecord[]

  @@index([courseId])
  @@index([date])
  @@map("attendance_sessions")
}

model AttendanceRecord {
  id          String           @id @default(cuid())
  sessionId   String
  userId      String
  status      AttendanceStatus @default(PRESENT)
  notes       String?
  markedAt    DateTime         @default(now())
  markedBy    String           // Who recorded the attendance

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  session     AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("attendance_records")
}

// ==================== USER ACTIVITY TELEMETRY (Phase 15) ====================

model UserActivity {
  id          String   @id @default(cuid())
  userId      String
  courseId     String?
  lessonId    String?
  eventType   String   // VIEW, SCROLL, VIDEO_PLAY, VIDEO_PAUSE, SUBMIT, LOGIN, IDLE
  metadata    Json?    // { scrollDepth, videoPercent, device, browser, etc. }
  sessionId   String?  // Client session grouping
  timestamp   DateTime @default(now())

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([timestamp])
  @@index([userId, courseId])
  @@index([eventType])
  @@map("user_activities")
}

// ==================== MFA (Phase 16) ====================

enum MFAMethod {
  EMAIL_OTP
}

model MFAConfig {
  id            String    @id @default(cuid())
  userId        String    @unique
  method        MFAMethod @default(EMAIL_OTP)
  isEnabled     Boolean   @default(false)
  backupCodes   Json?     // Array of hashed backup codes [{hash, used}]
  lastUsedAt    DateTime?
  failedAttempts Int      @default(0)
  lockedUntil   DateTime? // Lockout after too many failures

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mfa_configs")
}

model OTPToken {
  id          String   @id @default(cuid())
  userId      String
  code        String   // Hashed 6-digit code
  expiresAt   DateTime
  usedAt      DateTime?
  purpose     String   @default("MFA_LOGIN") // MFA_LOGIN, MFA_SETUP

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@map("otp_tokens")
}

// ==================== COURSE APPROVAL (Phase 16) ====================

enum ApprovalStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

model CourseApproval {
  id            String         @id @default(cuid())
  courseId       String         @unique
  status        ApprovalStatus @default(DRAFT)
  submittedAt   DateTime?
  reviewedBy    String?        // Admin user ID
  reviewedAt    DateTime?
  reviewComment String?        @db.Text
  history       Json?          // Array of {status, by, at, comment}

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  course        Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([submittedAt])
  @@map("course_approvals")
}

// ==================== EMAIL CAMPAIGNS (Phase 16) ====================

enum CampaignStatus {
  DRAFT
  SENDING
  SENT
  FAILED
  SCHEDULED
}

model EmailCampaign {
  id              String         @id @default(cuid())
  title           String
  subject         String
  content         String         @db.Text // HTML content
  recipientFilter Json           // { role, courseId, enrollmentStatus, inactiveDays, registeredAfter }
  status          CampaignStatus @default(DRAFT)
  sentAt          DateTime?
  scheduledFor    DateTime?
  sentBy          String         // Admin user ID
  sentCount       Int            @default(0)
  failedCount     Int            @default(0)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([sentBy])
  @@index([scheduledFor])
  @@map("email_campaigns")
}

// ==================== DATA RETENTION & COMPLIANCE (Phase 16) ====================

enum RetentionAction {
  ARCHIVE
  ANONYMIZE
  DELETE
}

enum DataType {
  USER_DATA
  ENROLLMENTS
  SUBMISSIONS
  TELEMETRY
  AUDIT_LOGS
  CHAT_MESSAGES
  FORUM_POSTS
}

enum ConsentType {
  DATA_PROCESSING
  ANALYTICS
  MARKETING
}

model RetentionPolicy {
  id            String          @id @default(cuid())
  dataType      DataType
  retentionDays Int             // Days to retain before action
  action        RetentionAction @default(ARCHIVE)
  isActive      Boolean         @default(true)
  lastExecutedAt DateTime?
  description   String?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@unique([dataType])
  @@map("retention_policies")
}

model ConsentRecord {
  id            String      @id @default(cuid())
  userId        String
  consentType   ConsentType
  granted       Boolean     @default(true)
  grantedAt     DateTime    @default(now())
  revokedAt     DateTime?
  ipAddress     String?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, consentType])
  @@index([userId])
  @@index([consentType])
  @@map("consent_records")
}

// ==================== CALENDAR SYSTEM (Phase 17) ====================

enum CalendarEventType {
  ASSIGNMENT_DUE
  ASSESSMENT_OPEN
  ASSESSMENT_CLOSE
  CONTENT_AVAILABLE
  ATTENDANCE_SESSION
  CUSTOM
}

model CalendarEvent {
  id            String            @id @default(cuid())
  title         String
  description   String?           @db.Text
  startDate     DateTime
  endDate       DateTime?
  allDay        Boolean           @default(false)
  type          CalendarEventType @default(CUSTOM)
  color         String?           // Hex color for UI display
  courseId       String?           // null = personal event
  userId        String?           // null = course-wide event
  referenceType String?           // "Assignment", "Quiz", "Chapter", "Lesson", "AttendanceSession"
  referenceId   String?           // ID of the referenced entity

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relations
  course        Course?           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user          User?             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([userId])
  @@index([startDate])
  @@index([type])
  @@index([referenceType, referenceId])
  @@map("calendar_events")
}

model CalendarToken {
  id        String   @id @default(cuid())
  token     String   @unique // Unique token for iCal subscription URL
  userId    String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([token])
  @@map("calendar_tokens")
}

// ==================== GROUPS SYSTEM (Phase 17) ====================

enum GroupRole {
  LEADER
  MEMBER
}

model CourseGroup {
  id          String   @id @default(cuid())
  name        String
  courseId     String
  maxMembers  Int      @default(5)
  createdBy   String   // Instructor who created it
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  members     GroupMember[]
  submissions AssignmentSubmission[]

  @@index([courseId])
  @@index([createdBy])
  @@map("course_groups")
}

model GroupMember {
  id        String    @id @default(cuid())
  groupId   String
  userId    String
  role      GroupRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  // Relations
  group     CourseGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("group_members")
}

// ==================== WEBHOOKS & API KEYS (Phase 19) ====================

enum WebhookEvent {
  ENROLLMENT_CREATED
  ENROLLMENT_COMPLETED
  ASSIGNMENT_SUBMITTED
  GRADE_UPDATED
  COURSE_PUBLISHED
  ASSESSMENT_ATTEMPTED
  USER_CREATED
}

model Webhook {
  id          String         @id @default(cuid())
  url         String
  description String?
  secret      String         // HMAC-SHA256 signing secret
  events      WebhookEvent[]
  isActive    Boolean        @default(true)
  userId      String         // Owner who created the webhook
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries  WebhookDelivery[]

  @@index([userId])
  @@index([isActive])
  @@map("webhooks")
}

model WebhookDelivery {
  id           String       @id @default(cuid())
  webhookId    String
  event        WebhookEvent
  payload      Json
  statusCode   Int?         // HTTP response status code (null if failed to connect)
  responseBody String?      @db.Text
  success      Boolean      @default(false)
  attempts     Int          @default(1)
  maxAttempts  Int          @default(5)
  nextRetryAt  DateTime?    // When to retry (null if no more retries)
  error        String?      @db.Text  // Error message if delivery failed
  deliveredAt  DateTime     @default(now())
  completedAt  DateTime?    // When the delivery was successfully completed or abandoned

  // Relations
  webhook      Webhook      @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([success, nextRetryAt]) // For retry cron query
  @@index([deliveredAt])
  @@map("webhook_deliveries")
}

enum APIKeyPermission {
  COURSES
  ENROLLMENTS
  GRADES
  USERS
  ANALYTICS
}

model APIKey {
  id          String             @id @default(cuid())
  name        String
  keyPrefix   String             // First 8 chars of key (for display: "ck_abc1...")
  keyHash     String             @unique // SHA-256 hash of the full key
  permissions APIKeyPermission[]
  userId      String             // Owner
  isActive    Boolean            @default(true)
  expiresAt   DateTime?          // Optional expiry
  lastUsedAt  DateTime?
  createdAt   DateTime           @default(now())

  // Relations
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
  @@index([isActive])
  @@map("api_keys")
}
